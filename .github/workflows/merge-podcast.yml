name: Merge Podcast with Intro and Outro

on:
  workflow_dispatch:
    inputs:
      podcast_url:
        description: 'Google Drive URL of main podcast'
        required: true
        type: string
      output_name:
        description: 'Output filename'
        required: true
        type: string
      phone_number:
        description: 'WhatsApp phone number for callback'
        required: true
        type: string

jobs:
  merge-podcast:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Download Intro from Google Drive
        env:
          INTRO_FILE_ID: ${{ secrets.INTRO_FILE_ID }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "Downloading intro..."
          python3 << 'EOF'
          import os
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io

          credentials_json = os.environ['GOOGLE_CREDENTIALS']
          credentials_dict = json.loads(credentials_json)
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/drive.readonly']
          )
          service = build('drive', 'v3', credentials=credentials)

          file_id = os.environ['INTRO_FILE_ID']
          request = service.files().get_media(fileId=file_id, supportsAllDrives=True)
          
          with open('intro.mp3', 'wb') as f:
              downloader = MediaIoBaseDownload(f, request)
              done = False
              while not done:
                  status, done = downloader.next_chunk()
          
          print(f"âœ… Intro downloaded: {os.path.getsize('intro.mp3')} bytes")
          EOF

            - name: Download Main Podcast from Google Drive
        env:
          PODCAST_URL: ${{ github.event.inputs.podcast_url }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "ðŸŽ™ï¸ Downloading main podcast from: $PODCAST_URL"
          python3 << 'EOF'
          import os
          import json
          import re
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io

          credentials_json = os.environ['GOOGLE_CREDENTIALS']
          credentials_dict = json.loads(credentials_json)
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/drive.readonly']
          )
          service = build('drive', 'v3', credentials=credentials)

          # Extract file ID from URL - supports multiple formats
          podcast_url = os.environ['PODCAST_URL']
          
          # Try format 1: https://drive.google.com/uc?id=FILE_ID&export=download
          file_id_match = re.search(r'[?&]id=([^&]+)', podcast_url)
          
          # Try format 2: https://drive.google.com/file/d/FILE_ID/...
          if not file_id_match:
              file_id_match = re.search(r'/file/d/([^/]+)', podcast_url)
          
          # Try format 3: https://drive.google.com/open?id=FILE_ID
          if not file_id_match:
              file_id_match = re.search(r'/open\?id=([^&]+)', podcast_url)
          
          if not file_id_match:
              raise ValueError(f"Could not extract file ID from URL: {podcast_url}")
          
          file_id = file_id_match.group(1)
          print(f"ðŸ“ Extracted file ID: {file_id}")

          # Download with Shared Drive support
          request = service.files().get_media(fileId=file_id, supportsAllDrives=True)
          
          with open('main_podcast.mp3', 'wb') as f:
              downloader = MediaIoBaseDownload(f, request)
              done = False
              while not done:
                  status, done = downloader.next_chunk()
                  if status:
                      print(f"Download progress: {int(status.progress() * 100)}%")
          
          file_size = os.path.getsize('main_podcast.mp3')
          print(f"âœ… Main podcast downloaded: {file_size} bytes")
          EOF
          
      - name: Download Outro from Google Drive
        env:
          OUTRO_FILE_ID: ${{ secrets.OUTRO_FILE_ID }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "Downloading outro..."
          python3 << 'EOF'
          import os
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io

          credentials_json = os.environ['GOOGLE_CREDENTIALS']
          credentials_dict = json.loads(credentials_json)
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/drive.readonly']
          )
          service = build('drive', 'v3', credentials=credentials)

          file_id = os.environ['OUTRO_FILE_ID']
          request = service.files().get_media(fileId=file_id, supportsAllDrives=True)
          
          with open('outro.mp3', 'wb') as f:
              downloader = MediaIoBaseDownload(f, request)
              done = False
              while not done:
                  status, done = downloader.next_chunk()
          
          print(f"âœ… Outro downloaded: {os.path.getsize('outro.mp3')} bytes")
          EOF

      - name: Verify all files exist
        run: |
          echo "ðŸ“‹ Verifying downloaded files..."
          ls -lah *.mp3
          
          echo "ðŸ” Checking file types..."
          file intro.mp3
          file main_podcast.mp3
          file outro.mp3
          
          echo "âœ… All files verified!"

      - name: Merge podcasts with FFmpeg
        run: |
          echo "ðŸŽ¬ Merging podcasts..."
          python3 podcast_merger_simple.py
          
          echo "ðŸ“Š Final podcast info:"
          ls -lah final_podcast.mp3
          file final_podcast.mp3

      - name: Upload to Google Drive
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          OUTPUT_NAME: ${{ github.event.inputs.output_name }}
        run: |
          echo "â¬†ï¸ Uploading final podcast to Google Drive..."
          python3 upload_to_drive.py

      - name: Notify n8n webhook
        if: success()
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          PHONE_NUMBER: ${{ github.event.inputs.phone_number }}
        run: |
          # Extract file ID from drive_file_id.txt (created by upload_to_drive.py)
          if [ -f "drive_file_id.txt" ]; then
            FILE_ID=$(cat drive_file_id.txt)
            echo "ðŸ“¤ Sending webhook to n8n..."
            curl -X POST "$N8N_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"status\":\"success\",\"file_id\":\"$FILE_ID\",\"phone_number\":\"$PHONE_NUMBER\"}"
          else
            echo "âŒ drive_file_id.txt not found!"
            exit 1
          fi
